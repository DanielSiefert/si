---
name: build-docker-images

on:
  push:
    branches:
      - staging
      - trying

jobs:
  check-changes:
    name: Check changed paths
    runs-on: self-hosted
    outputs:
      nats-changed: ${{ steps.check-component-changes.outputs.component--nats }}
      otelcol-changed: ${{ steps.check-component-changes.outputs.component--otelcol }}
      postgres-changed: ${{ steps.check-component-changes.outputs.component--postgres }}
      sdf-changed: ${{ steps.check-component-changes.outputs.bin--sdf }}
      veritech-changed: ${{ steps.check-component-changes.outputs.bin--veritech }}
      web-changed: ${{ steps.check-component-changes.outputs.app--web }}
      pinga-changed: ${{ steps.check-component-changes.outputs.bin--pinga }}
      council-changed: ${{ steps.check-component-changes.outputs.bin--council }}
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 1000
      - id: check-component-changes
        run: ./ci/scripts/check-for-component-changes.sh
  nats:
    name: "Build nats image"
    needs: check-changes
    if: needs.check-changes.outputs.nats-changed == 'true'
    uses: ./.github/workflows/build-docker-image.yml
    with:
      component_name: component/nats
    secrets:
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_PASSWORD: ${{ secrets.DOCKERHUB_PASSWORD }}
  otelcol:
    name: "Build otelcol image"
    needs: check-changes
    if: needs.check-changes.outputs.otelcol-changed == 'true'
    uses: ./.github/workflows/build-docker-image.yml
    with:
      component_name: component/otelcol
    secrets:
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_PASSWORD: ${{ secrets.DOCKERHUB_PASSWORD }}
  postgres:
    name: "Build postgres image"
    needs: check-changes
    if: needs.check-changes.outputs.postgres-changed == 'true'
    uses: ./.github/workflows/build-docker-image.yml
    with:
      component_name: component/postgres
    secrets:
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_PASSWORD: ${{ secrets.DOCKERHUB_PASSWORD }}
  sdf:
    name: "Build sdf image"
    needs: check-changes
    if: needs.check-changes.outputs.sdf-changed == 'true'
    uses: ./.github/workflows/build-docker-image.yml
    with:
      component_name: bin/sdf
    secrets:
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_PASSWORD: ${{ secrets.DOCKERHUB_PASSWORD }}
  veritech:
    name: "Build veritech image"
    needs: check-changes
    if: needs.check-changes.outputs.veritech-changed == 'true'
    uses: ./.github/workflows/build-docker-image.yml
    with:
      component_name: bin/veritech
    secrets:
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_PASSWORD: ${{ secrets.DOCKERHUB_PASSWORD }}
  web:
    name: "Build web image"
    needs: check-changes
    if: needs.check-changes.outputs.web-changed == 'true'
    uses: ./.github/workflows/build-docker-image.yml
    with:
      component_name: app/web
    secrets:
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_PASSWORD: ${{ secrets.DOCKERHUB_PASSWORD }}
  pinga:
    name: "Build pinga image"
    needs: check-changes
    if: needs.check-changes.outputs.pinga-changed == 'true'
    uses: ./.github/workflows/build-docker-image.yml
    with:
      component_name: bin/pinga
    secrets:
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_PASSWORD: ${{ secrets.DOCKERHUB_PASSWORD }}
  council:
    name: "Build council image"
    needs: check-changes
    if: needs.check-changes.outputs.council-changed == 'true'
    uses: ./.github/workflows/build-docker-image.yml
    with:
      component_name: bin/council
    secrets:
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_PASSWORD: ${{ secrets.DOCKERHUB_PASSWORD }}
  summary:
    name: Docker Image Build Summary Status
    runs-on: self-hosted
    needs:
      - check-changes
      - nats
      - otelcol
      - postgres
      - sdf
      - veritech
      - web
      - pinga
      - council
    if: always()
    env:
      CHECK_CHANGES_STATUS: ${{ needs.check-changes.result }}
      NATS_RUN: ${{ needs.check-changes.outputs.nats-changed }}
      OTELCOL_RUN: ${{ needs.check-changes.outputs.otelcol-changed }}
      PINGA_RUN: ${{ needs.check-changes.outputs.pinga-changed }}
      COUNCIL_RUN: ${{ needs.check-changes.outputs.council-changed }}
      POSTGRES_RUN: ${{ needs.check-changes.outputs.postgres-changed }}
      SDF_RUN: ${{ needs.check-changes.outputs.sdf-changed }}
      VERITECH_RUN: ${{ needs.check-changes.outputs.veritech-changed }}
      WEB_RUN: ${{ needs.check-changes.outputs.web-changed }}
      NATS_STATUS: ${{ needs.nats.result }}
      OTELCOL_STATUS: ${{ needs.otelcol.result }}
      PINGA_STATUS: ${{ needs.pinga.result }}
      COUNCIL_STATUS: ${{ needs.council.result }}
      POSTGRES_STATUS: ${{ needs.postgres.result }}
      SDF_STATUS: ${{ needs.sdf.result }}
      VERITECH_STATUS: ${{ needs.veritech.result }}
      WEB_STATUS: ${{ needs.web.result }}
    steps:
      - uses: actions/checkout@v2
      - id: check-build-statuses
        run: ./ci/scripts/check-image-build-statuses.sh
